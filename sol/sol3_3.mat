clear all; close all;
load data/hw3_prob3.mat

function res = Dh(x)
    res = circshift(x, -1, 1) - x;
end

function res = Dht(x)
    res = circshift(x, 1, 1) - x;
end

function res = Dv(x)
    res = circshift(x, -1, 2) - x;
end

function res = Dvt(x)
    res = circshift(x, 1, 2) - x;
end

%% Parameters
TOL= 2e-4;
lambda=1;
x0= x_orig;
[n1, n2]= size(x0);
tau= 1/normest(A).^2; 
sigma= 1/(tau*normest(A)^2);

%% Initialization
x= zeros(size(x0));
z1= zeros(size(b));
z2= zeros(size(x0));
z3= zeros(size(x0));

%% Iterate

for iter=1:10000;
    iter

    x_old=x;
    z1_old=z1;
    z2_old=z2;
    z3_old=z3;

    x= reshape(x,n1,n2);
    Dhx= Dh(x); 
    Dvx= Dv(x);
    x= x(:);

    %% update z
    tempz1= z1(:)+sigma*(A*x(:));
    tempz2= z2(:)+sigma*(Dhx(:));
    tempz3= z3(:)+sigma*(Dvx(:));
    z1= (tempz1-sigma*lambda*b)./(1+sigma*lambda);

    TH= sigma;
    z2= sign(tempz2).*min(abs(tempz2),TH);
    z3= sign(tempz3).*min(abs(tempz3),TH);

    %% update x
    z2= reshape(z2,n1,n2);
    z3= reshape(z3,n1,n2);

    Dht2= Dht(z2);
    Dvt3= Dvt(z3);
    tempx= x(:)-tau*(A'*z1(:) + Dht2(:) + Dvt3(:) );
    x= max(tempx, 0);

    theta= 1/(sqrt(1+2*lambda*tau));
    tau= theta*tau;
    sigma= sigma/theta;

    if iter>1;
        x= x + theta*(x-x_old);
    end

    % figure(1); imagesc(reshape(x,n1,n2)); colormap gray; axis image;

    norm(x(:)-x_old(:))/norm(x(:))
    if iter>10 && norm(x-x_old)/norm(x) < TOL;
        disp('Tol. reached');
        break;
    end
end